name: Release

on:
  push:
    branches:
      - release

permissions:
  contents: write

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from latest tag
        id: version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION (tag: $TAG)"

  build:
    needs: [get-version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-amd64
            runner: ubuntu-latest
            rustTargets: ""
            tauriArgs: ""
          - name: linux-arm64
            runner: ubuntu-24.04-arm
            rustTargets: ""
            tauriArgs: ""
          - name: macos-arm64
            runner: macos-latest
            rustTargets: aarch64-apple-darwin
            tauriArgs: "--target aarch64-apple-darwin"
          - name: macos-x64
            runner: macos-latest
            rustTargets: x86_64-apple-darwin
            tauriArgs: "--target x86_64-apple-darwin"
          - name: windows
            runner: windows-latest
            rustTargets: ""
            tauriArgs: ""
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rustTargets }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            build-essential \
            pkg-config \
            patchelf \
            libfuse2 \
            xdg-utils \
            rpm

      - name: Install dependencies
        run: pnpm install

      - name: Build Tauri app
        run: pnpm tauri build ${{ matrix.tauriArgs }}

      - name: Upload build artifacts (host)
        if: matrix.rustTargets == ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: src-tauri/target/release/bundle/**
          if-no-files-found: error
          retention-days: 1

      - name: Upload build artifacts (target)
        if: matrix.rustTargets != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: src-tauri/target/${{ matrix.rustTargets }}/release/bundle/**
          if-no-files-found: error
          retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: [get-version, build]
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f -print0 | sort -z | xargs -0 sha256sum > checksums.txt

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.tag }}
          name: CryptoTray ${{ needs.get-version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**
            artifacts/checksums.txt
