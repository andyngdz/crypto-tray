name: Release

on:
  push:
    branches:
      - release

permissions:
  contents: write

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"
  WAILS_VERSION: "v2.11.0"
  APP_NAME: "crypto-tray"

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from latest tag
        id: version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION (tag: $TAG)"

  build-linux:
    needs: [get-version]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config \
            rpm \
            libfuse2

      - name: Install cross-compilation tools (arm64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: pnpm install
        working-directory: frontend

      - name: Build for Linux ${{ matrix.arch }}
        env:
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
          CC: ${{ matrix.arch == 'arm64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
        run: wails build -platform linux/${{ matrix.arch }} -tags webkit2_41 -trimpath -clean

      - name: Create tar.gz archive
        run: |
          cd build/bin
          tar -czvf ${{ env.APP_NAME }}-linux-${{ matrix.arch }}.tar.gz ${{ env.APP_NAME }}

      - name: Build .deb package
        run: |
          mkdir -p deb-pkg/DEBIAN
          mkdir -p deb-pkg/usr/bin
          mkdir -p deb-pkg/usr/share/applications
          mkdir -p deb-pkg/usr/share/icons/hicolor/256x256/apps

          cp build/bin/${{ env.APP_NAME }} deb-pkg/usr/bin/
          cp build/linux/CryptoTray.desktop deb-pkg/usr/share/applications/${{ env.APP_NAME }}.desktop
          cp build/appicon.png deb-pkg/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png || true

          cat > deb-pkg/DEBIAN/control << EOF
          Package: ${{ env.APP_NAME }}
          Version: ${{ needs.get-version.outputs.version }}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch == 'amd64' && 'amd64' || 'arm64' }}
          Maintainer: CryptoTray
          Description: Cryptocurrency price tracker for system tray
          EOF

          dpkg-deb --build deb-pkg build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.deb

      - name: Build .rpm package
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          cat > rpmbuild/SPECS/${{ env.APP_NAME }}.spec << EOF
          Name: ${{ env.APP_NAME }}
          Version: ${{ needs.get-version.outputs.version }}
          Release: 1
          Summary: Cryptocurrency price tracker for system tray
          License: MIT

          %description
          CryptoTray displays cryptocurrency prices in your system tray.

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/applications
          cp %{_sourcedir}/${{ env.APP_NAME }} %{buildroot}/usr/bin/
          cp %{_sourcedir}/${{ env.APP_NAME }}.desktop %{buildroot}/usr/share/applications/

          %files
          /usr/bin/${{ env.APP_NAME }}
          /usr/share/applications/${{ env.APP_NAME }}.desktop
          EOF

          cp build/bin/${{ env.APP_NAME }} rpmbuild/SOURCES/
          cp build/linux/CryptoTray.desktop rpmbuild/SOURCES/${{ env.APP_NAME }}.desktop

          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/${{ env.APP_NAME }}.spec
          cp rpmbuild/RPMS/*/*.rpm build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.rpm

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

      - name: Build .AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp build/bin/${{ env.APP_NAME }} AppDir/usr/bin/
          cp build/linux/CryptoTray.desktop AppDir/${{ env.APP_NAME }}.desktop
          cp build/appicon.png AppDir/${{ env.APP_NAME }}.png || true
          cp build/appicon.png AppDir/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png || true

          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          exec "${HERE}/usr/bin/${{ env.APP_NAME }}" "$@"
          EOF
          chmod +x AppDir/AppRun

          ARCH=${{ matrix.arch == 'amd64' && 'x86_64' || 'aarch64' }} ./appimagetool AppDir build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.AppImage

      - name: Rename binary
        run: mv build/bin/${{ env.APP_NAME }} build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: |
            build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}
            build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.tar.gz
            build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.deb
            build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.rpm
            build/bin/${{ env.APP_NAME }}-linux-${{ matrix.arch }}.AppImage
          retention-days: 1

  build-macos:
    needs: [get-version]
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: pnpm install
        working-directory: frontend

      - name: Build for macOS ${{ matrix.arch }}
        run: wails build -platform darwin/${{ matrix.arch }} -trimpath -clean

      - name: Create DMG
        run: |
          cd build/bin
          mkdir -p dmg-content
          mv ${{ env.APP_NAME }}.app dmg-content/CryptoTray.app

          hdiutil create -volname "CryptoTray" -srcfolder dmg-content -ov -format UDZO ${{ env.APP_NAME }}-darwin-${{ matrix.arch }}.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: darwin-${{ matrix.arch }}
          path: build/bin/${{ env.APP_NAME }}-darwin-${{ matrix.arch }}.dmg
          retention-days: 1

  build-windows:
    needs: [get-version]
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: pnpm install
        working-directory: frontend

      - name: Build for Windows amd64 with NSIS installer
        run: wails build -platform windows/amd64 -nsis -trimpath -clean

      - name: Rename artifacts
        shell: pwsh
        run: |
          Move-Item build/bin/${{ env.APP_NAME }}.exe build/bin/${{ env.APP_NAME }}-windows-amd64.exe
          Move-Item build/bin/${{ env.APP_NAME }}-amd64-installer.exe build/bin/${{ env.APP_NAME }}-windows-amd64-installer.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            build/bin/${{ env.APP_NAME }}-windows-amd64.exe
            build/bin/${{ env.APP_NAME }}-windows-amd64-installer.exe
          retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: [get-version, build-linux, build-macos, build-windows]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Linux amd64
          cp artifacts/linux-amd64/${{ env.APP_NAME }}-linux-amd64 release-assets/
          cp artifacts/linux-amd64/${{ env.APP_NAME }}-linux-amd64.tar.gz release-assets/
          cp artifacts/linux-amd64/${{ env.APP_NAME }}-linux-amd64.deb release-assets/
          cp artifacts/linux-amd64/${{ env.APP_NAME }}-linux-amd64.rpm release-assets/
          cp artifacts/linux-amd64/${{ env.APP_NAME }}-linux-amd64.AppImage release-assets/

          # Linux arm64
          cp artifacts/linux-arm64/${{ env.APP_NAME }}-linux-arm64 release-assets/
          cp artifacts/linux-arm64/${{ env.APP_NAME }}-linux-arm64.tar.gz release-assets/
          cp artifacts/linux-arm64/${{ env.APP_NAME }}-linux-arm64.deb release-assets/
          cp artifacts/linux-arm64/${{ env.APP_NAME }}-linux-arm64.rpm release-assets/
          cp artifacts/linux-arm64/${{ env.APP_NAME }}-linux-arm64.AppImage release-assets/

          # macOS
          cp artifacts/darwin-amd64/${{ env.APP_NAME }}-darwin-amd64.dmg release-assets/
          cp artifacts/darwin-arm64/${{ env.APP_NAME }}-darwin-arm64.dmg release-assets/

          # Windows
          cp artifacts/windows-amd64/${{ env.APP_NAME }}-windows-amd64.exe release-assets/
          cp artifacts/windows-amd64/${{ env.APP_NAME }}-windows-amd64-installer.exe release-assets/

          # Set executable permissions
          chmod +x release-assets/${{ env.APP_NAME }}-linux-*
          chmod +x release-assets/*.AppImage

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum * > checksums.txt

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.tag }}
          name: CryptoTray ${{ needs.get-version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-assets/${{ env.APP_NAME }}-linux-amd64
            release-assets/${{ env.APP_NAME }}-linux-amd64.tar.gz
            release-assets/${{ env.APP_NAME }}-linux-amd64.deb
            release-assets/${{ env.APP_NAME }}-linux-amd64.rpm
            release-assets/${{ env.APP_NAME }}-linux-amd64.AppImage
            release-assets/${{ env.APP_NAME }}-linux-arm64
            release-assets/${{ env.APP_NAME }}-linux-arm64.tar.gz
            release-assets/${{ env.APP_NAME }}-linux-arm64.deb
            release-assets/${{ env.APP_NAME }}-linux-arm64.rpm
            release-assets/${{ env.APP_NAME }}-linux-arm64.AppImage
            release-assets/${{ env.APP_NAME }}-darwin-amd64.dmg
            release-assets/${{ env.APP_NAME }}-darwin-arm64.dmg
            release-assets/${{ env.APP_NAME }}-windows-amd64.exe
            release-assets/${{ env.APP_NAME }}-windows-amd64-installer.exe
            release-assets/checksums.txt
